<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <title>Batch Solver [Prototype]</title>
        <style>
            textarea {
                font-size: 1rem;
            }

            .adv-layout {
                text-align: left;
            }   

            .button {
                border: none;
                color: white;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                transition-duration: 0.4s;
                cursor: pointer;
                background-color: white;
                color: black;
                border: 0.125rem solid #000;
            }

            .top-button {
                padding: 1rem 1.75rem;
                margin: 0.25rem 0.125rem;
            }

            .add-subgroup, .remove-subgroup {
                padding: 0.063rem 0.313rem;
                margin: 0rem 0rem;
            }
    
            .button:hover {
                background-color: #000;
                color: white;
            }

            button:disabled {
                opacity: 0.3;
                cursor: none;
                pointer-events: none;
            }

            input[type=checkbox] {
                transform: scale(1.3);
            }

            #input-area tr {
                height: 1.875rem;
            }

            #input-area td, #input-area th {
                text-align: left;
                vertical-align: top;
                padding: 0;
            }

            #table-area table {
                border-color: black;
                border-width: 0.063rem 0.063rem 0.125rem 0.063rem;
                border-style: solid;
            }

            #table-area td {
                border-color: black;
                border-width: 0.063rem 0.063rem 0 0;
                border-style: solid;
                padding: 0.188rem;
                height: 1em;
                text-align: left;
                vertical-align: top;
                white-space: nowrap;
            }

            #table-area th {
                border-color: black;
                border-width: 0.063rem 0.063rem 0 0;
                border-style: solid;
                padding: 0.188rem;
                text-align: center;
            }

            #table-area .output-left {
                border-color: black;
                border-width: 0.063rem 0.063rem 0 0.063rem;
                border-style: solid;                
            }

            #maxSolutions {
                vertical-align: middle;
                resize: none;
                width: 4.5rem;
            }

        </style>
    </head>
    
    <body>
        <div style="font-family:courier new;font-size:18px">
            <strong>
                <div id="input-area">
                    Puzzle<br>
                    <textarea id="puzzle" rows="15" cols="84" spellcheck="false">
U: (UF UL UB UR) (UFR UFL UBL UBR)
R: (UR BR DR FR) (UFR-1 UBR+1 DBR-1 DFR+1)
F: (UF+1 FR+1 DF+1 FL+1) (UFR+1 DFR-1 DFL+1 UFL-1)
D: (DF DR DB DL) (DFR DBR DBL DFL)
L: (UL FL DL BL) (UFL+1 DFL-1 DBL+1 UBL-1)
B: (UB+1 BL+1 DB+1 BR+1) (UBR-1 UBL+1 DBL-1 DBR+1)
u: (UF UL UB UR) (UFR UFL UBL UBR) (FR+1 FL+1 BL+1 BR+1) (FB RL+1 FB+1)
r: (UR BR DR FR) (UFR-1 UBR+1 DBR-1 DFR+1) (UF+1 UB+1 DB+1 DF+1) (FB UD+1 FB+1)
f: (UF+1 FR+1 DF+1 FL+1) (UFR+1 DFR-1 DFL+1 UFL-1) (UR+1 DR+1 DL+1 UL+1) (UD RL+1 UD+1)
d: (DF DR DB DL) (DFR DBR DBL DFL) (FR+1 BR+1 BL+1 FL+1) (RL FB+1 RL+1)
l: (UL FL DL BL) (UFL+1 DFL-1 DBL+1 UBL-1) (UF+1 DF+1 DB+1 UB+1) (UD FB+1 UD+1)
b: (UB+1 BL+1 DB+1 BR+1) (UBR-1 UBL+1 DBL-1 DBR+1) (UR+1 UL+1 DL+1 DR+1) (RL UD+1 RL+1)
M: (UF+1 DF+1 DB+1 UB+1) (UD FB+1 UD+1)
S: (UR+1 DR+1 DL+1 UL+1) (UD RL+1 UD+1)
E: (FR+1 BR+1 BL+1 FL+1) (RL FB+1 RL+1)</textarea><br><br>
                    Unique Orientations & Equivalences<br>
                    <textarea id="ignore" rows="4" cols="84" spellcheck="false"></textarea><br><br>

                    <table id="subgroup-table">
                        <tr id="subgroup-row-1">
                            <th style="vertical-align: bottom">Prune</th>
                            <th style="vertical-align: bottom">Search</th>
                            <th style="vertical-align: bottom">Adjust</th>
                            <th style="vertical-align: bottom">Subgroup</th>
                            <th>
                                <button style="font-family:courier new; font-size:17px" class="button add-subgroup" onclick="subgroupButtonHandler(this)"><strong>+</strong></button>
                            </th>
                        </tr>
                        <tr id="subgroup-row-2">
                            <td><textarea class="prune" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td><textarea class="search" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td><textarea class="adjust" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td><textarea class="subgroup" rows="1" cols="42" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td>
                                <button style="font-family:courier new; font-size:17px" class="button remove-subgroup" disabled onclick="subgroupButtonHandler(this)"><strong>-</strong></button>
                            </td>
                        </tr>
                    </table><br>
                    Scramble<br>
                    <textarea id="solve" rows="3" cols="84" spellcheck="false"></textarea><br>
                    <table id="batch-adjustments">
                        <tr id="pre-adjust-table">
                            <th style="vertical-align: bottom">Pre-Adjust</th>
                            <th style="vertical-align: bottom">Post-Adjust</th>
                        </tr>
                        <tr id="post-adjust-table">
                            <td><textarea id="pre-adjustments" rows="1" cols="14" spellcheck="false">U</textarea>&nbsp;&nbsp;</td>
                            <td><textarea id="post-adjustments" rows="1" cols="14" spellcheck="false">U</textarea>&nbsp;&nbsp;</td>
                        </tr>
                    </table><br>
                </div>
            Options
            </strong>
            <div id="options">
                <input id="sortByMCC" type="checkbox" checked><label for="sortByMCC"> Sort algs by movecount coefficient</label><br>
                <input type="checkbox" id="statVis" onclick="statVisibility(this)" checked/><label for="statVis"> Show statistics</label><br>
                <input type="checkbox" id="optVis" onclick="optionVisibility(this)" /><label for="optVis"> Show advanced speed options</label><br>
                Show top <input type="number" id="maxSolutions" value="100"></input> solutions for each case<br>
            </div>

            <div id="advanced" hidden>
                <br>
                <table class="adv-layout">
                    <tr>
                        <th>Wrist Turn Multiplier:</th>
                        <th>
                            <input type="range" value="0.8" max="1" step="0.05" oninput="p1.value = this.value">
                            <output id="p1">0.8</output><br>
                        </th>
                    </tr>
                    <tr>
                        <th>Push Turn Multiplier:</th>
                        <th>
                            <input type="range" value="1.3" min="1" max="3" step="0.05" oninput="p2.value = this.value">
                            <output id="p2">1.3</output><br>
                        </th>
                    </tr>
                    <tr>
                        <th>Ring Turn Multiplier:</th>
                        <th>
                            <input type="range" value="1.4" min="1" max="3" step="0.05" oninput="p3.value = this.value">
                            <output id="p3">1.4</output><br>
                        </th>
                    </tr>
                    <tr>
                        <th>Destabilize Penalty:</th>
                        <th>
                            <input type="range" value="0.5" max="2" step="0.05" oninput="p4.value = this.value">
                            <output id="p4">0.5</output><br>
                        </th>
                    </tr> 
                    <tr>
                        <th>Soft Regrip Penalty:</th>
                        <th>
                            <input type="range" value="1" max="4" step="0.05" oninput="p5.value = this.value">
                            <output id="p5">1</output><br>
                        </th>
                    </tr> 
                    <tr>
                        <th>Half Turn Multiplier:</th>
                        <th>
                            <input type="range" value="1.65" min="1" max="2" step="0.05" oninput="p6.value = this.value">
                            <output id="p6">1.65</output><br>
                        </th>
                    </tr> 
                    <tr>
                        <th>S/E Slice Multiplier:</th>
                        <th>
                            <input type="range" value="1.25" min="1" max="2" step="0.05" oninput="p7.value = this.value">
                            <output id="p7">1.25</output><br>
                        </th>
                    </tr> 
                    <tr>
                        <th>Overwork Penalty:</th>
                        <th>
                            <input type="range" value="2.25" max="5" step="0.05" oninput="p8.value = this.value">
                            <output id="p8">2.25</output><br>
                        </th>
                    </tr>
                    <tr>
                        <th>Move Block Penalty:</th>
                        <th>
                            <input type="range" value="0.8" min="0" max="3" step="0.05" oninput="p9.value = this.value">
                            <output id="p9">0.8</output><br>
                        </th>
                    </tr> 
                    <tr>
                        <th>y/z Rotation:</th>
                        <th>
                            <input type="range" value="3.5" min="1" max="7" step="0.1" oninput="p10.value = this.value">
                            <output id="p10">3.5</output><br>
                        </th>
                    </tr>                     
                </table>
            </div><br>

            <div id="statistics">
                <strong>Statistics</strong><br>
                Case: <span id="info-this-case">0</span>/<span id="info-num-cases">0</span><br>
                Rate: <span id="info-time">0.00 sec/case</span><br>
                MCC: <span id="info-mcc"> 0.00 </span><br>
                HTM: <span id="info-htm"> 0.00 </span><br>
                QTM: <span id="info-qtm"> 0.00 </span><br>

            </div><br>

            <button style="font-family:courier new;font-size:18px" class="button top-button" onclick="searchButtonHandler()" id="calc-button"><strong>Start Search</strong></button> 
            <button style="font-family:courier new;font-size:18px" class="button top-button" onclick="clearOutput()" id="clear-button"><strong>Clear Output</strong></button><br>

            <div id="table-area" hidden><br>
                <strong>Output</strong>
                <table cellspacing="0" id="output-table">
                    <tr id="computation-header"></tr>
                    <tr id="solutions-header"></tr>
                    <tr id="output-data"></tr>
                </table>
            </div>
        </div>
        <br><br><br><br><br><br><br><br><br>
    <script src="../algSpeed.js"></script>
    <script>
                
        function statVisibility() {
            if (statVis.checked) {
                document.getElementById("statistics").hidden = false;
            } else {
                document.getElementById("statistics").hidden = true;
            }
        }

        function optionVisibility() {
            if (optVis.checked) {
                advanced.hidden = false;
            } else {
                advanced.hidden = true;
            }
        }

        let work;
        let addBufferInterval;
        let solveID = 0;
        let depth = 0;
        let numSolutions;
        let subgroupRowID = 3;
        let subgroupRows = 1;
        let speedBuffer = [];
        let solutionsBuffer = [];
        let debugVars = [];

        let startTime = Date.now();
        let isIdle = true;
        let totalMCC, totalHTM, totalQTM;

        function createSolutionTable() {
            document.getElementById("computation-header").innerHTML += '<th colspan="2" class="output-left">#'+solveID+'<br><span id="progUpdate'+solveID+'"></span></th>';
            document.getElementById("solutions-header").innerHTML += '<th class="output-left">&nbsp;Speed&nbsp;<th>&nbsp;Solutions&nbsp;</th></th>';
            document.getElementById("output-data").innerHTML += '<td class="output-left" id="speed'+solveID+'"></td><td id="solutions'+solveID+'"></td>';
        }

        function getWorkerData() {
            let subgroupData = [];
            let pruneDepths = document.querySelectorAll(".prune");
            let searchDepths = document.querySelectorAll(".search");
            let adjustments = document.querySelectorAll(".adjust");
            let subgroups = document.querySelectorAll(".subgroup");

            for (let i=0; i<pruneDepths.length; i++) {
                subgroupData.push(
                {subgroup: subgroups[i].value,
                prune: pruneDepths[i].value,
                search: searchDepths[i].value,
                adjust: adjustments[i].value});
            }
            return {puzzle: document.getElementById('puzzle').value, 
                    ignore: document.getElementById('ignore').value,
                    solve: document.getElementById('solve').value,
                    preAdjust: document.getElementById('pre-adjustments').value,
                    postAdjust: document.getElementById('post-adjustments').value,
                    subgroups: subgroupData};
        }

        function appendBuffer() {
            let solutionsLeft = parseInt(document.getElementById("maxSolutions").value, 10) - document.getElementById("speed"+solveID).innerHTML.split("<br>").length;
            if (solutionsLeft > 0) {
                document.getElementById("speed"+solveID).innerHTML += speedBuffer.slice(0, solutionsLeft).join("<br>")+"<br>";
                document.getElementById("solutions"+solveID).innerHTML += solutionsBuffer.slice(0, solutionsLeft).join("<br>")+"<br>";
            }
            speedBuffer = [];
            solutionsBuffer = [];
        }

        function customParseFloat(x) {
            let pFloat = parseFloat(x);
            if (pFloat !== pFloat) {return Infinity} else {return pFloat}
        }

        function getCombinedBuffer() {
            let combinedBuffer = [];
            for (let i=0; i<solutionsBuffer.length; i++) {
                combinedBuffer.push([speedBuffer[i], solutionsBuffer[i]]);
            }
            combinedBuffer.sort((x,y)=>(customParseFloat(x[0])>customParseFloat(y[0])?1:-1));
            return combinedBuffer;
        }

        function mergeBuffer() {
            let sortedBuffer = getCombinedBuffer();
            let updatedSpeedData = "";
            let updatedSolutionsData = "";
            let tableNeedle = 0;
            let bufferNeedle = 0;
            let tableSpeedList = document.getElementById("speed"+solveID).innerHTML.split("<br>");
            let tableSolutionList = document.getElementById("solutions"+solveID).innerHTML.split("<br>");

            function addFromBuffer() {
                updatedSpeedData += sortedBuffer[bufferNeedle][0] + "<br>";
                updatedSolutionsData += sortedBuffer[bufferNeedle][1] + "<br>";
                bufferNeedle++;
            }

            function addFromTable() {
                updatedSpeedData += tableSpeedList[tableNeedle] + "<br>";
                updatedSolutionsData += tableSolutionList[tableNeedle] + "<br>";
                tableNeedle++;   
            }

            for (let i=0; i<Math.min(parseInt(document.getElementById("maxSolutions").value, 10),tableSpeedList.length+sortedBuffer.length); i++) {
                if (tableNeedle === tableSpeedList.length) {
                    addFromBuffer();
                } else if (bufferNeedle === sortedBuffer.length) {
                    addFromTable();
                } else {
                    if (customParseFloat(sortedBuffer[bufferNeedle][0]) < customParseFloat(tableSpeedList[tableNeedle])) {addFromBuffer()} else {addFromTable()}
                }
            }

            document.getElementById("speed"+solveID).innerHTML = updatedSpeedData;
            document.getElementById("solutions"+solveID).innerHTML = updatedSolutionsData;
            speedBuffer = [];
            solutionsBuffer = [];
        }

        function getFirstLine(fieldStr) {
            let firstNew = fieldStr.indexOf("\n");
            return fieldStr.slice(0,firstNew);
        }

        function getHTM(move) {
            return 1;
        }

        function getQTM(move) {
            let numericMove = move.replace(/[^0-9\.]/g, ""); // removes all nonnumeric characters from move
            if (numericMove == "") {return 1} else {return parseInt(numericMove, 10)}
        }

        function getMoveCount(alg, metric) {
            if (alg == "") {return NaN} // because if no algs were genned then the stats wouldn't be relevant
            let splitAlg = alg.split(" ");
            let count = 0;
            let insideParen = false;
            for (let move of splitAlg) {
                if (move == "") {
                    continue;
                } else if (move.includes(")")) {
                    insideParen = false;
                } else if (move.includes("(")) {
                    insideParen = true;
                } else if (insideParen == false) {
                    count += metric(move);
                }
            }
            return count;
        }

        function updateStats() {
            let numCases = parseInt(document.getElementById("info-this-case").innerHTML, 10)+1;
            let topSolution = getFirstLine(document.getElementById("solutions"+solveID).innerText);
            document.getElementById("info-this-case").innerHTML = numCases;
            document.getElementById("info-time").innerHTML = ((Date.now()-startTime)/numCases/1000).toFixed(2)+" sec/case";
            totalMCC += parseFloat(getFirstLine(document.getElementById("speed"+solveID).innerText), 10)
            document.getElementById("info-mcc").innerHTML = (totalMCC/numCases).toFixed(2);
            totalHTM += getMoveCount(topSolution, getHTM);
            document.getElementById("info-htm").innerHTML = (totalHTM/numCases).toFixed(2);
            totalQTM += getMoveCount(topSolution, getQTM);
            document.getElementById("info-qtm").innerHTML = (totalQTM/numCases).toFixed(2);
        }

        function addBufferToTable() { // add buffer to table and update statistics
            if (solutionsBuffer.length === 0) {return}
            if (document.getElementById("sortByMCC").checked) {
                mergeBuffer();
            } else {
                appendBuffer();
            }
        }

        function searchButtonHandler() {
            if (document.getElementById("calc-button").innerText == "Start Search") {
                calc();
            } else {
                stopSearch();
            }
        }

        function initNextState() {
            solveID++;
            numSolutions = 0;
            createSolutionTable();
        }

        function calc() {
            work = new Worker("worker.js");
            isIdle = false;
            startTime = Date.now();
            totalMCC = totalHTM = totalQTM = 0;

            document.getElementById("info-this-case").innerHTML = 0;
            document.getElementById("info-num-cases").innerHTML = 0;
            document.getElementById("info-time").innerHTML = "0.0 sec/case";
            document.getElementById("info-mcc").innerHTML = "0.00";
            document.getElementById("info-htm").innerHTML = "0.00";
            document.getElementById("info-qtm").innerHTML = "0.00";

            document.getElementById("calc-button").innerHTML = "<strong>&nbsp;End Search&nbsp;</strong>";
            document.getElementById("table-area").hidden = false;
            document.getElementById("clear-button").disabled = true;

            initNextState();
            addBufferInterval = setInterval(addBufferToTable, 250);
            work.postMessage(getWorkerData());

            work.onmessage = function(event) {
                if (event.data.type === "stop") {
                    stopSearch();
                    let msg = event.data.value;
                    if (msg !== null) {alert(msg)} else {updateStats()}
                } else if (event.data.type === "depthUpdate") {
                    depth++;
                    document.getElementById("progUpdate"+solveID).innerHTML = "<small>Searching depth "+depth+"</small>";
                } else if (event.data.type === "solution") {
                    let solution = event.data.value;
                    let parenIndex = solution.indexOf(")");
                    let trimmedSolution = (parenIndex > -1) ? (solution.slice(parenIndex+1)) : solution;
                    let speed = algSpeed(trimmedSolution, false, true, parseFloat(document.getElementById("p1").innerHTML),parseFloat(document.getElementById("p2").innerHTML),parseFloat(document.getElementById("p3").innerHTML),parseFloat(document.getElementById("p4").innerHTML),parseFloat(document.getElementById("p5").innerHTML),parseFloat(document.getElementById("p6").innerHTML),parseFloat(document.getElementById("p7").innerHTML),parseFloat(document.getElementById("p8").innerHTML),parseFloat(document.getElementById("p9").innerHTML),parseFloat(document.getElementById("p10").innerHTML));
                    speedBuffer.push(speed);
                    solutionsBuffer.push(solution);
                    numSolutions++;
                } else if (event.data.type === "set-depth") {
                    depth = event.data.value;
                } else if (event.data.type === "next-state" && event.data.value > 1) {
                    addBufferToTable();
                    updateStats();
                    initNextState();
                } else if (event.data.type === "num-states") {
                    document.getElementById("info-num-cases").innerHTML = event.data.value;
                }
                else if (event.data.type === "debug") {
                    debugVars.push(event.data.value);
                }
            }
        }

        function stopSearch() {
            addBufferToTable();
            clearInterval(addBufferInterval);
            work.terminate();
            isIdle = true;
            document.getElementById("calc-button").innerHTML = "<strong>Start Search</strong>";
            document.getElementById("clear-button").disabled = false;
            document.getElementById("progUpdate"+solveID).innerHTML = "<small>Search finished</small>";
            depth = 0;
        }

        function clearOutput() {
            document.getElementById("output-table").innerHTML = '<tr id="computation-header"></tr><tr id="solutions-header"></tr><tr id="output-data"></tr>';
            document.getElementById("table-area").hidden = true;
            solveID = 0;
        }

        function subgroupButtonHandler(e) {
            if (e.className == "button add-subgroup") {
                let tbody = document.getElementById("subgroup-table").children[0];
                let clone = document.getElementById("subgroup-row-1").cloneNode(true);
                clone.innerHTML = `
                    <td><textarea class="prune" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td><textarea class="search" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td><textarea class="adjust" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td><textarea class="subgroup" rows="1" cols="42" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td>
                        <button style="font-family:courier new;font-size:17px" class="button remove-subgroup" onclick="subgroupButtonHandler(this)"><strong>-</strong></button>
                    </td>`;
                clone.id = "subgroup-row-"+subgroupRowID;
                tbody.appendChild(clone);
                document.querySelector(".remove-subgroup").disabled = false;
                subgroupRowID++;
                subgroupRows++;
            } else {
                e.parentNode.parentNode.remove();
                subgroupRows--;
                if (subgroupRows == 1) {
                    document.querySelector(".remove-subgroup").disabled = true;
                }
            }
        }
        
</script>

</body>

</html>