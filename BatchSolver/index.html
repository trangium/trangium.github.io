<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <title>Batch Solver</title>
        <style>
            textarea {
                font-size: 1rem;
            }

            .button {
                border: none;
                color: white;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                transition-duration: 0.4s;
                cursor: pointer;
                background-color: white;
                color: black;
                border: 0.125rem solid #000;
            }

            .top-button {
                padding: 1rem 1.75rem;
                margin: 0.25rem 0.125rem;
            }

            .add-subgroup, .remove-subgroup {
                padding: 0.063rem 0.313rem;
                margin: 0rem 0rem;
            }
    
            .button:hover {
                background-color: #000;
                color: white;
            }

            button:disabled {
                opacity: 0.3;
                cursor: none;
                pointer-events: none;
            }

            input[type=checkbox] {
                transform: scale(1.3);
            }

            #input-area tr {
                height: 1.875rem;
            }

            #input-area td, #input-area th {
                text-align: left;
                vertical-align: top;
                padding: 0;
            }

            #table-area table {
                border-color: black;
                border-width: 0.063rem 0.063rem 0.125rem 0.063rem;
                border-style: solid;
            }

            #table-area td {
                border-color: black;
                border-width: 0.063rem 0.063rem 0 0;
                border-style: solid;
                padding: 0.188rem;
                height: 1em;
                text-align: left;
                vertical-align: top;
                white-space: nowrap;
            }

            #table-area th {
                border-color: black;
                border-width: 0.063rem 0.063rem 0 0;
                border-style: solid;
                padding: 0.188rem;
                text-align: center;
            }

            #table-area .output-left {
                border-color: black;
                border-width: 0.063rem 0.063rem 0 0.063rem;
                border-style: solid;                
            }

            #maxSolutions {
                vertical-align: middle;
                resize: none;
                width: 4.5rem;
            }

        </style>
    </head>
    
    <body>
        <div style="font-family:courier new;font-size:18px">
            <button style="font-family:courier new;font-size:18px" class="button top-button" onclick="searchButtonHandler()" id="calc-button"><strong>Start Search</strong></button> 
            <button style="font-family:courier new;font-size:18px" class="button top-button" onclick="clearOutput()" id="clear-button"><strong>Clear Output</strong></button><br>
                
            <strong><br>
                <div id="options">
                    <input id="sortByMCC" type="checkbox"><label for="sortByMCC"> Sort algs by movecount coefficient</label><br>
                    Show top <input type="number" id="maxSolutions" value="100"></input> solutions for each case<br><br>
                </div>

                <div id="input-area">
                    Puzzle<br>
                    <textarea id="puzzle" rows="15" cols="84" spellcheck="false">
U: (UF UL UB UR) (UFR UFL UBL UBR)
R: (UR BR DR FR) (UFR-1 UBR+1 DBR-1 DFR+1)
F: (UF+1 FR+1 DF+1 FL+1) (UFR+1 DFR-1 DFL+1 UFL-1)
D: (DF DR DB DL) (DFR DBR DBL DFL)
L: (UL FL DL BL) (UFL+1 DFL-1 DBL+1 UBL-1)
B: (UB+1 BL+1 DB+1 BR+1) (UBR-1 UBL+1 DBL-1 DBR+1)
u: (UF UL UB UR) (UFR UFL UBL UBR) (FR+1 FL+1 BL+1 BR+1) (FB RL+1 FB+1)
r: (UR BR DR FR) (UFR-1 UBR+1 DBR-1 DFR+1) (UF+1 UB+1 DB+1 DF+1) (FB UD+1 FB+1)
f: (UF+1 FR+1 DF+1 FL+1) (UFR+1 DFR-1 DFL+1 UFL-1) (UR+1 DR+1 DL+1 UL+1) (UD RL+1 UD+1)
d: (DF DR DB DL) (DFR DBR DBL DFL) (FR+1 BR+1 BL+1 FL+1) (RL FB+1 RL+1)
l: (UL FL DL BL) (UFL+1 DFL-1 DBL+1 UBL-1) (UF+1 DF+1 DB+1 UB+1) (UD FB+1 UD+1)
b: (UB+1 BL+1 DB+1 BR+1) (UBR-1 UBL+1 DBL-1 DBR+1) (UR+1 UL+1 DL+1 DR+1) (RL UD+1 RL+1)
M: (UF+1 DF+1 DB+1 UB+1) (UD FB+1 UD+1)
S: (UR+1 DR+1 DL+1 UL+1) (UD RL+1 UD+1)
E: (FR+1 BR+1 BL+1 FL+1) (RL FB+1 RL+1)</textarea><br><br>
                    Unique Orientations & Equivalences<br>
                    <textarea id="ignore" rows="4" cols="84" spellcheck="false"></textarea><br><br>

                    <table id="subgroup-table">
                        <tr id="subgroup-row-1">
                            <th style="vertical-align: bottom">Prune</th>
                            <th style="vertical-align: bottom">Search</th>
                            <th style="vertical-align: bottom">Adjust</th>
                            <th style="vertical-align: bottom">Subgroup</th>
                            <th>
                                <button style="font-family:courier new; font-size:17px" class="button add-subgroup" onclick="subgroupButtonHandler(this)"><strong>+</strong></button>
                            </th>
                        </tr>
                        <tr id="subgroup-row-2">
                            <td><textarea class="prune" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td><textarea class="search" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td><textarea class="adjust" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td><textarea class="subgroup" rows="1" cols="42" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                            <td>
                                <button style="font-family:courier new; font-size:17px" class="button remove-subgroup" disabled onclick="subgroupButtonHandler(this)"><strong>-</strong></button>
                            </td>
                        </tr>
                    </table><br>

                    Scramble<br>
                    <textarea id="solve" rows="3" cols="84" spellcheck="false"></textarea><br><br>
                </div>
            </strong>
            <div id="table-area" hidden>
                <strong>Output</strong>
                <table cellspacing="0" id="output-table">
                    <tr id="computation-header"></tr>
                    <tr id="solutions-header"></tr>
                    <tr id="output-data"></tr>
                </table>
            </div>
        </div>
    <script src="../algSpeed.js"></script>
    <script>
        let work;
        let addBufferInterval;
        let solveID = 0;
        let depth = 0;
        let numSolutions;
        let subgroupRowID = 3;
        let subgroupRows = 1;
        let speedBuffer = [];
        let solutionsBuffer = [];

        function createSolutionTable() {
            document.getElementById("computation-header").innerHTML += '<th colspan="2" class="output-left">#'+solveID+'<br><span id="progUpdate'+solveID+'"></span></th>';
            document.getElementById("solutions-header").innerHTML += '<th class="output-left">&nbsp;Speed&nbsp;<th>&nbsp;Solutions&nbsp;</th></th>';
            document.getElementById("output-data").innerHTML += '<td class="output-left" id="speed'+solveID+'"></td><td id="solutions'+solveID+'"></td>';
        }

        function getWorkerData() {
            let subgroupData = [];
            let pruneDepths = document.querySelectorAll(".prune");
            let searchDepths = document.querySelectorAll(".search");
            let adjustments = document.querySelectorAll(".adjust");
            let subgroups = document.querySelectorAll(".subgroup");

            for (let i=0; i<pruneDepths.length; i++) {
                subgroupData.push(
                {subgroup: subgroups[i].value,
                prune: pruneDepths[i].value,
                search: searchDepths[i].value,
                adjust: adjustments[i].value});
            }
            return {puzzle: document.getElementById('puzzle').value, 
                    ignore: document.getElementById('ignore').value,
                    solve: document.getElementById('solve').value,
                    subgroups: subgroupData};
        }

        function appendBuffer() {
            let solutionsLeft = parseInt(document.getElementById("maxSolutions").value) - document.getElementById("speed"+solveID).innerHTML.split("<br>").length;
            if (solutionsLeft > 0) {
                document.getElementById("speed"+solveID).innerHTML += speedBuffer.slice(0, solutionsLeft).join("<br>")+"<br>";
                document.getElementById("solutions"+solveID).innerHTML += solutionsBuffer.slice(0, solutionsLeft).join("<br>")+"<br>";
            }
            speedBuffer = [];
            solutionsBuffer = [];
        }

        function customParseFloat(x) {
            let pFloat = parseFloat(x);
            if (pFloat !== pFloat) {return Infinity} else {return pFloat}
        }

        function getCombinedBuffer() {
            let combinedBuffer = [];
            for (let i=0; i<solutionsBuffer.length; i++) {
                combinedBuffer.push([speedBuffer[i], solutionsBuffer[i]]);
            }
            combinedBuffer.sort((x,y)=>(customParseFloat(x[0])>customParseFloat(y[0])?1:-1));
            return combinedBuffer;
        }

        function mergeBuffer() {
            let sortedBuffer = getCombinedBuffer();
            let updatedSpeedData = "";
            let updatedSolutionsData = "";
            let tableNeedle = 0;
            let bufferNeedle = 0;
            let tableSpeedList = document.getElementById("speed"+solveID).innerHTML.split("<br>");
            let tableSolutionList = document.getElementById("solutions"+solveID).innerHTML.split("<br>");

            function addFromBuffer() {
                updatedSpeedData += sortedBuffer[bufferNeedle][0] + "<br>";
                updatedSolutionsData += sortedBuffer[bufferNeedle][1] + "<br>";
                bufferNeedle++;
            }

            function addFromTable() {
                updatedSpeedData += tableSpeedList[tableNeedle] + "<br>";
                updatedSolutionsData += tableSolutionList[tableNeedle] + "<br>";
                tableNeedle++;   
            }

            for (let i=0; i<Math.min(parseInt(document.getElementById("maxSolutions").value),tableSpeedList.length+sortedBuffer.length); i++) {
                if (tableNeedle === tableSpeedList.length) {
                    addFromBuffer();
                } else if (bufferNeedle === sortedBuffer.length) {
                    addFromTable();
                } else {
                    if (customParseFloat(sortedBuffer[bufferNeedle][0]) < customParseFloat(tableSpeedList[tableNeedle])) {addFromBuffer()} else {addFromTable()}
                }
            }

            document.getElementById("speed"+solveID).innerHTML = updatedSpeedData;
            document.getElementById("solutions"+solveID).innerHTML = updatedSolutionsData;
            speedBuffer = [];
            solutionsBuffer = [];
        }

        function addBufferToTable() {
            if (solutionsBuffer.length === 0) {return}
            if (document.getElementById("sortByMCC").checked) {
                mergeBuffer();
            } else {
                appendBuffer();
            }
        }

        function searchButtonHandler() {
            if (document.getElementById("calc-button").innerText == "Start Search") {
                calc();
            } else {
                stopSearch();
            }
        }

        function initNextState() {
            solveID++;
            numSolutions = 0;
            createSolutionTable();
        }

        function calc() {
            work = new Worker("worker.js");

            document.getElementById("calc-button").innerHTML = "<strong>&nbsp;End Search&nbsp;</strong>";
            document.getElementById("table-area").hidden = false;
            document.getElementById("clear-button").disabled = true;

            initNextState();
            addBufferInterval = setInterval(addBufferToTable, 250);
            work.postMessage(getWorkerData());

            work.onmessage = function(event) {
                if (event.data.type === "stop") {
                    stopSearch();
                } else if (event.data.type === "depthUpdate") {
                    depth++;
                    document.getElementById("progUpdate"+solveID).innerHTML = "<small>Searching depth "+depth+"</small>";
                } else if (event.data.type === "solution") {
                    let speed = algSpeed(event.data.value, false, true);
                    let solution = event.data.value;
                    speedBuffer.push(speed);
                    solutionsBuffer.push(solution);
                    numSolutions++;
                } else if (event.data.type === "set-depth") {
                    depth = event.data.value;
                } else if (event.data.type === "next-state" && event.data.value > 1) {
                    addBufferToTable();
                    initNextState();
                }
            }
        }

        function stopSearch() {
            addBufferToTable();
            clearInterval(addBufferInterval);
            work.terminate();
            document.getElementById("calc-button").innerHTML = "<strong>Start Search</strong>";
            document.getElementById("clear-button").disabled = false;
            document.getElementById("progUpdate"+solveID).innerHTML = "<small>Search finished</small>";
            depth = 0;
        }

        function clearOutput() {
            document.getElementById("output-table").innerHTML = '<tr id="computation-header"></tr><tr id="solutions-header"></tr><tr id="output-data"></tr>';
            document.getElementById("table-area").hidden = true;
            solveID = 0;
        }

        function subgroupButtonHandler(e) {
            if (e.className == "button add-subgroup") {
                let tbody = document.getElementById("subgroup-table").children[0];
                let clone = document.getElementById("subgroup-row-1").cloneNode(true);
                clone.innerHTML = `
                    <td><textarea class="prune" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td><textarea class="search" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td><textarea class="adjust" rows="1" cols="7" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td><textarea class="subgroup" rows="1" cols="42" spellcheck="false"></textarea>&nbsp;&nbsp;</td>
                    <td>
                        <button style="font-family:courier new;font-size:17px" class="button remove-subgroup" onclick="subgroupButtonHandler(this)"><strong>-</strong></button>
                    </td>`;
                clone.id = "subgroup-row-"+subgroupRowID;
                tbody.appendChild(clone);
                document.querySelector(".remove-subgroup").disabled = false;
                subgroupRowID++;
                subgroupRows++;
            } else {
                e.parentNode.parentNode.remove();
                subgroupRows--;
                if (subgroupRows == 1) {
                    document.querySelector(".remove-subgroup").disabled = true;
                }
            }
        }
        
</script>

</body>

</html>